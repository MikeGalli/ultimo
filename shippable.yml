language: node_js

node_js: 
    - 0.12

# build image
build_image: shippableimages/ubuntu1404_nodejs

env: 
  global:
    - PROJECT=KariGran HIPCHAT_ROOM=KariGran
    - REMOTE_HOST=kg.dev.ottemo.io FOUNDATION_URI=http://foundation.kg.dev.ottemo.io
    - secure: JePvX8e49vPPWRLagd9lvuwV8wRBUD1EDkHnANJ8bTzfnDiAPBgqrgocliz7KR6F5ZPHBAvRkrIa6ZP1PVLdC/LeOzoojFyPzU7iiKxkatT2+Ry+QKnH603UGJzIfui1bLQ/eZT2D8wOjMggs4z8DXH62HCmzl+ovhboU1XBYRBuYVMZBKKN/2kcz8LVTZ0BP9jLLMJ5xHb9PDOX7fwBREnjn0dN2yy6uNpz9t7rKJCxNf4uk7+M6AHrryU4mEHpEfu9wbUhMGve5Del78YcZfc5PMDtmKqvamUDICOMCzHRFdl3kpkNsr72ynoZ3s0Vus/3cH9hShCfHNacVk4xQA==
    - secure: dNcmaHssl+2DzpCxXk90IXwcaQ1nS2DCBmVgZRyYUkkLsPYFSeO0UV1Adohpf6mBLM3h4+i5M2SBl7m5ZwjDnUXKUTQYc0Z32semUdFb4CjuLeubMeLXMuDiGh1AwZPhJ3Ki6H1BEG1XekUHoVl7Nc218RX9gATKIQtSrfAdgT6kgnSdbvd4Z2u7YX6iGWld1pu6xYf0Q9y24eUEPkQUxiCSFp+qutj+e5zeq//Y/615RM9ImIqPYRTGUQmxeNWSKH4iGE/vf5nrwfl+Y7EoxI8cSvAv4TfgMM59mj5brAzplWhN80Isjy1TmNj+bBkxHLyVH90exgcgV2fzZMD0NIAr11//hmIo6g4EREDSymi6CiCGjER0pY+nHVEipJKS5njLLrBNF/yHzmmf44+pbmM/g6C0n2LLR8R6BOhmx9QH9tInbDLzRZ/VN5mB9TqOeJuVg7EE+3SiyvOeHqV0aehV7IHzE5TRrukVYZ8TDJZ4jgS4eXTkE7SFBa3tCXtmg2fJiwejHfDe6Wl7/KgpZdB6wqouVXjhmSFFLFhw6EWYnJRFazHLg+iJlLQHdrvkgF5SHZPAFkK0zow1bwEn2XearC7NQLTbHUTiyXckgypkVCn3Je69noN5SUBlftCOiMNPfyhxPh0xmUMjcyRjSVRxikvV4q+P7mCE53VhP8Q=

before_install:
    # install NodeJS v0.12
    - source ~/.nvm/nvm.sh && nvm install $SHIPPABLE_NODE_VERSION
    - npm update -g npm 
    - npm version
    - npm install -g gulp bower

install: 
    # install the required dependencies
    - npm install
    - bower install --allow-root

script: 
    - NODE_ENV=production gulp build

after_failure:
    - python hipchat_notifier.py --project $PROJECT --room $HIPCHAT_ROOM --token $HIPCHAT_TOKEN

after_success:
    - echo "$REMOTE_HOST_KEY" >> ./id_rsa.pub && chmod 400 ./id_rsa.pub 
    - scp -i id_rsa.pub dist ottemo@$REMOTE_HOST:~/storefront/dist
    - python hipchat_notifier.py --project $PROJECT --room $HIPCHAT_ROOM --token $HIPCHAT_TOKEN -s
